<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合約自動化生成系統 (最終版)</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        h3 { color: #0056b3; margin-top: 25px; }
        .page { display: none; }
        .page.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        select.inline-select { width: auto; padding: 4px; margin: 0 5px; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        .btn-group { margin-top: 20px; text-align: right; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button.secondary { background-color: #6c757d; } button.success { background-color: #28a745; }
        .table-input { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .table-input th, .table-input td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .table-input th { background-color: #f8f9fa; }
        .checkbox-group label { display: inline-block; margin-right: 15px; cursor: pointer; }
        .hidden { display: none; }
        .info-box { background-color: #e2e3e5; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #d6d8db; }
        .required-mark { color: red; }
    </style>
</head>
<body>

<div class="container">
    <h1>合約自動化生成程式</h1>
    
    <!-- 第一頁 -->
    <div id="page1" class="page active">
        <h2>步驟 1/3：合約類型選擇</h2>
        <div class="form-group">
            <label>請選擇合約類型：</label>
            <div class="checkbox-group">
                <label><input type="radio" name="contractType" value="new" checked> 新簽約</label>
                <label><input type="radio" name="contractType" value="renew"> 續約</label>
            </div>
        </div>
        <div class="btn-group"><button onclick="nextPage(2)">下一步 &gt;</button></div>
    </div>

    <!-- 第二頁 -->
    <div id="page2" class="page">
        <h2>步驟 2/3：基本資料與費用</h2>
        <h3>2-1. 合約期間</h3>
        <div class="row">
            <div class="col"><label>起始日期</label><div class="row"><select id="startYear" onchange="calcDuration()"><option value="">年</option></select><select id="startMonth" onchange="calcDuration()"><option value="">月</option></select><select id="startDay" onchange="calcDuration()"><option value="">日</option></select></div></div>
            <div class="col"><label>結束日期</label><div class="row"><select id="endYear" onchange="calcDuration()"><option value="">年</option></select><select id="endMonth" onchange="calcDuration()"><option value="">月</option></select><select id="endDay" onchange="calcDuration()"><option value="">日</option></select></div></div>
        </div>
        <div class="form-group"><label>期間計算結果</label><input type="text" id="durationResult" readonly style="background:#e9ecef;"></div>
        <div class="form-group">
            <label>封底日期 <span style="color:blue;font-weight:normal;">(預設今日)</span></label>
            <div class="row" style="max-width:400px;"><select id="coverYear"></select><select id="coverMonth"></select><select id="coverDay"></select></div>
        </div>

        <h3>基本資料</h3>
        <div class="row"><div class="col"><label>2-1-1 社區名稱 <span class="required-mark">*</span></label><input type="text" id="commName" required></div><div class="col"><label>2-1-2 地址 <span class="required-mark">*</span></label><input type="text" id="commAddr" required></div></div>
        <div class="row"><div class="col"><label>2-1-3 乙方 <span class="required-mark">*</span></label><input type="text" id="partyB" required></div><div class="col"><label>2-1-4 代表人 <span class="required-mark">*</span></label><input type="text" id="repName" required></div></div>
        <div class="row"><div class="col"><label>2-1-5 電話 <span class="required-mark">*</span></label><input type="text" id="phone" required></div><div class="col"><label>2-1-6 統編</label><input type="text" id="taxId"></div></div>

        <h3>2-2 & 2-3. 設備與費用</h3>
        <table class="table-input">
            <thead><tr><th>項目</th><th width="15%">數量</th><th>位置</th><th>單價</th><th>小計</th></tr></thead>
            <tbody>
                <tr><td>EIP聯網機(1)</td><td><input type="number" id="qty_eip_net_1" value="0" onchange="calcFees()"></td><td><input type="text" id="loc_eip_net_1" value="大廳/梯廳"></td><td><input type="number" id="price_eip_net_1" value="0" onchange="calcFees()"></td><td><input type="text" id="sub_eip_net_1" readonly></td></tr>
                <tr><td>EIP聯網機(2)</td><td><input type="number" id="qty_eip_net_2" value="0" onchange="calcFees()"></td><td><input type="text" id="loc_eip_net_2" value="大廳/梯廳"></td><td><input type="number" id="price_eip_net_2" value="0" onchange="calcFees()"></td><td><input type="text" id="sub_eip_net_2" readonly></td></tr>
                <tr><td>EIP公告機</td><td><input type="number" id="qty_eip_anno" value="0" onchange="calcFees()"></td><td><input type="text" id="loc_eip_anno" value="電梯車廂內"></td><td><input type="number" id="price_eip_anno" value="0" onchange="calcFees()"></td><td><input type="text" id="sub_eip_anno" readonly></td></tr>
                <tr><td colspan="4" style="text-align:right;font-weight:bold;">合計(月)</td><td><input type="text" id="total_monthly" readonly style="color:red;font-weight:bold;"></td></tr>
            </tbody>
        </table>

        <h3>2-4. 匯款帳戶</h3>
        <div class="row"><div class="col"><label>銀行 <span class="required-mark">*</span></label><input type="text" id="bankName" required></div><div class="col"><label>分行 <span class="required-mark">*</span></label><input type="text" id="bankBranch" required></div></div>
        <div class="row"><div class="col"><label>戶名 <span class="required-mark">*</span></label><input type="text" id="acctName" required></div><div class="col"><label>帳號 <span class="required-mark">*</span></label><input type="text" id="acctNum" required></div></div>
        
        <div class="btn-group"><button class="secondary" onclick="prevPage(1)">&lt; 上一步</button><button onclick="nextPage(3)">下一步 &gt;</button></div>
    </div>

    <!-- 第三頁 -->
    <div id="page3" class="page">
        <h2>步驟 3/3：條款勾選與生成</h2>
        <div class="form-group">
            <label>3-1. 到期處理方式</label>
            <div class="checkbox-group">
                <label><input type="radio" name="expiryOpt" value="1" checked> 自動延展 <select id="renewalYear" class="inline-select" onclick="event.stopPropagation()"><option value="壹">壹</option><option value="貳">貳</option><option value="參">參</option></select> 年</label><br>
                <label style="margin-top:5px;"><input type="radio" name="expiryOpt" value="2"> 須重簽合約</label>
            </div>
        </div>
        <div class="form-group">
            <label>3-2. 通知方式</label>
            <div><label><input type="checkbox" id="notify_line"> Line@</label> <label><input type="checkbox" id="notify_paper"> 書面</label> <label><input type="checkbox" id="notify_screen"> 屏幕</label></div>
            <div><label><input type="checkbox" id="notify_email" onchange="toggleEmailInput()"> Email</label></div>
            <div id="emailInputArea" class="hidden indent"><div class="row"><input placeholder="甲方Email" id="mail_addr_a"><input placeholder="乙方Email" id="mail_addr_b"></div></div>
            <div><label><input type="checkbox" id="notify_other" onchange="toggleOtherInput()"> 其他</label></div>
            <div id="otherInputArea" class="hidden indent"><input type="text" id="other_social_text" placeholder="軟體名稱"></div>
        </div>
        
        <div class="form-group">
            <label>3-3. 特別約定事項</label>
            <div class="checkbox-group">
                <label><input type="radio" name="specialOpt" value="1" checked onchange="toggleSpecialInput()"> 無</label><br>
                <label><input type="radio" name="specialOpt" value="2" onchange="toggleSpecialInput()"> 特別約定事項如下：</label>
            </div>
            <div id="specialInputArea" class="indent hidden">
                <textarea id="special_terms_text" rows="5" placeholder="請輸入內容..."></textarea>
            </div>
        </div>

        <hr>
        <div class="info-box">
            <strong>Word 範本設定提醒：</strong><br>
            為確保「特別約定事項」有固定大小且不跑版，請在 Word 範本中將該區域改為<strong>「固定列高」的表格</strong>，並設定網底顏色。<br>
            程式會將千分位金額與處理好的文字填入該表格中。
        </div>

        <div class="btn-group"><button class="secondary" onclick="prevPage(2)">&lt; 上一步</button><button class="success" onclick="generateContract()">生成 Word</button></div>
    </div>
</div>

<script>
    window.onload = function() { initDateSelects(); setDefaultCoverDate(); };

    function initDateSelects() {
        const ids = ['start', 'end', 'cover'];
        ids.forEach(prefix => {
            const y = document.getElementById(prefix+'Year'), m = document.getElementById(prefix+'Month'), d = document.getElementById(prefix+'Day');
            for(let i=113; i<=130; i++) y.add(new Option(i, i));
            for(let i=1; i<=12; i++) m.add(new Option(i<10?'0'+i:i, i<10?'0'+i:i));
            for(let i=1; i<=31; i++) d.add(new Option(i<10?'0'+i:i, i<10?'0'+i:i));
        });
    }
    function setDefaultCoverDate() {
        const t = new Date(), y = t.getFullYear()-1911, m = (t.getMonth()+1).toString().padStart(2,'0'), d = t.getDate().toString().padStart(2,'0');
        const ySel = document.getElementById('coverYear');
        for(let i=0;i<ySel.options.length;i++) if(ySel.options[i].value==y) { ySel.selectedIndex=i; document.getElementById('coverMonth').value=m; document.getElementById('coverDay').value=d; break; }
    }
    function formatMoney(n) { return (n===null||isNaN(n)) ? "0" : n.toLocaleString('en-US'); }
    function numToChi(n) {
        const m=['零','壹','貳','參','肆','伍','陸','柒','捌','玖']; n=parseInt(n); if(isNaN(n)||n===0)return "零";
        let s=""; if(n>=100){s+=m[Math.floor(n/100)]+"佰";n%=100;if(n>0&&n<10)s+="零";} if(n>=10){s+=m[Math.floor(n/10)]+"拾";n%=10;} if(n>0)s+=m[n]; return s;
    }
    function loadFile(u,c) { var x=new XMLHttpRequest(); x.open('GET',u,true); x.responseType='arraybuffer'; x.onload=function(){if(this.status===200)c(null,this.response);else c(new Error(this.status));}; x.send(); }
    
    function nextPage(p) {
        if(p===3) {
            let v=true, f=null; ['commName','commAddr','partyB','repName','phone','bankName','bankBranch','acctName','acctNum'].forEach(id=>{
                let e=document.getElementById(id); if(!e.value.trim()){e.style.border="2px solid red";v=false;if(!f)f=e;}else{e.style.border="1px solid #ccc";}
            });
            if(!v){ alert("請填寫必填欄位"); if(f)f.scrollIntoView({behavior:"smooth",block:"center"}); return; }
        }
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); document.getElementById('page'+p).classList.add('active'); window.scrollTo(0,0);
    }
    function prevPage(p) { nextPage(p); }
    function toggleEmailInput() { document.getElementById('emailInputArea').classList.toggle('hidden', !document.getElementById('notify_email').checked); }
    function toggleOtherInput() { document.getElementById('otherInputArea').classList.toggle('hidden', !document.getElementById('notify_other').checked); }
    function toggleSpecialInput() { document.getElementById('specialInputArea').classList.toggle('hidden', !document.querySelector('input[name="specialOpt"][value="2"]').checked); }

    function calcDuration() {
        const sY=parseInt(document.getElementById('startYear').value), sM=parseInt(document.getElementById('startMonth').value), sD=parseInt(document.getElementById('startDay').value);
        const eY=parseInt(document.getElementById('endYear').value), eM=parseInt(document.getElementById('endMonth').value), eD=parseInt(document.getElementById('endDay').value);
        if(!sY||!sM||!sD||!eY||!eM||!eD) return;
        let start=new Date(sY+1911,sM-1,sD), end=new Date(eY+1911,eM-1,eD), dEnd=new Date(end); dEnd.setDate(dEnd.getDate()+1);
        let ys=dEnd.getFullYear()-start.getFullYear(), ms=dEnd.getMonth()-start.getMonth(), ds=dEnd.getDate()-start.getDate();
        if(ds<0){ ms--; ds+=new Date(dEnd.getFullYear(),dEnd.getMonth(),0).getDate(); } if(ms<0){ ys--; ms+=12; }
        document.getElementById('durationResult').value=`共計${numToChi(ys)}年${numToChi(ms)}月${numToChi(ds)}日`;
    }
    function calcFees() {
        let q1=parseInt(document.getElementById('qty_eip_net_1').value)||0, p1=parseInt(document.getElementById('price_eip_net_1').value)||0, s1=q1*p1;
        let q2=parseInt(document.getElementById('qty_eip_net_2').value)||0, p2=parseInt(document.getElementById('price_eip_net_2').value)||0, s2=q2*p2;
        let q3=parseInt(document.getElementById('qty_eip_anno').value)||0, p3=parseInt(document.getElementById('price_eip_anno').value)||0, s3=q3*p3;
        document.getElementById('sub_eip_net_1').value="NT$"+formatMoney(s1); document.getElementById('sub_eip_net_2').value="NT$"+formatMoney(s2);
        document.getElementById('sub_eip_anno').value=q3===0?"N/A":"NT$"+formatMoney(s3);
        document.getElementById('total_monthly').value="NT$"+formatMoney(s1+s2+s3);
    }

    function generateContract() {
        loadFile("./template.docx", function(err, content) {
            if(err) { alert("無法讀取 template.docx"); return; }
            try {
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
                
                const isRenew = document.querySelector('input[name="contractType"]:checked').value === 'renew';
                const CHECKED="☑", UNCHECKED="☒";
                
                // 取得數值與千分位處理
                const q1=parseInt(document.getElementById('qty_eip_net_1').value)||0, p1=parseInt(document.getElementById('price_eip_net_1').value)||0;
                const q2=parseInt(document.getElementById('qty_eip_net_2').value)||0, p2=parseInt(document.getElementById('price_eip_net_2').value)||0;
                const q3=parseInt(document.getElementById('qty_eip_anno').value)||0, p3=parseInt(document.getElementById('price_eip_anno').value)||0;
                const sub1=q1*p1, sub2=q2*p2, sub3=q3*p3, totalNet=q1+q2, totalFee=sub1+sub2+sub3;
                
                let priceNetStr = "NT$" + formatMoney(p1);
                if(q2>0 && p1!==p2) priceNetStr = `NT$${formatMoney(p1)} / NT$${formatMoney(p2)}`;

                // 特別約定事項清理
                let specialText = "";
                if(document.querySelector('input[name="specialOpt"][value="2"]').checked) {
                    specialText = (document.getElementById('special_terms_text').value||"").replace(/(\r\n|\n|\r)/gm, "\n").trim();
                }

                doc.render({
                    check_new: isRenew?UNCHECKED:CHECKED, check_renew: isRenew?CHECKED:UNCHECKED,
                    start_year: document.getElementById('startYear').value, start_month: document.getElementById('startMonth').value, start_day: document.getElementById('startDay').value,
                    end_year: document.getElementById('endYear').value, end_month: document.getElementById('endMonth').value, end_day: document.getElementById('endDay').value,
                    duration_str: document.getElementById('durationResult').value,
                    cover_year: document.getElementById('coverYear').value, cover_month: document.getElementById('coverMonth').value, cover_day: document.getElementById('coverDay').value,
                    comm_name: document.getElementById('commName').value, comm_addr: document.getElementById('commAddr').value,
                    party_b: document.getElementById('partyB').value, rep_name: document.getElementById('repName').value,
                    phone: document.getElementById('phone').value, tax_id: document.getElementById('taxId').value,
                    bank_info: document.getElementById('bankName').value+"-"+document.getElementById('bankBranch').value,
                    acct_name: document.getElementById('acctName').value, acct_num: document.getElementById('acctNum').value,
                    
                    qty_total_net: totalNet, qty_total_net_chi: totalNet===0?"零":numToChi(totalNet),
                    qty_net_1_chi: q1===0?"N/A":numToChi(q1), loc_net_1: document.getElementById('loc_eip_net_1').value,
                    qty_net_2_chi: q2===0?"N/A":numToChi(q2), loc_net_2: document.getElementById('loc_eip_net_2').value,
                    qty_anno_chi: q3===0?"N/A":numToChi(q3), loc_anno: document.getElementById('loc_eip_anno').value,
                    
                    qty_fee_net_chi: totalNet===0?"N/A":numToChi(totalNet), price_fee_net: priceNetStr, sub_fee_net: "NT$"+formatMoney(sub1+sub2),
                    qty_fee_anno_chi: q3===0?"N/A":numToChi(q3), price_fee_anno: q3===0?"N/A":"NT$"+formatMoney(p3), sub_fee_anno: q3===0?"N/A":"NT$"+formatMoney(sub3),
                    total_monthly: "NT$"+formatMoney(totalFee),

                    check_expiry_1: document.querySelector('input[name="expiryOpt"][value="1"]').checked?CHECKED:UNCHECKED,
                    check_expiry_2: document.querySelector('input[name="expiryOpt"][value="2"]').checked?CHECKED:UNCHECKED,
                    renewal_year_chi: document.getElementById('renewalYear').value,
                    
                    check_notify_line: document.getElementById('notify_line').checked?CHECKED:UNCHECKED,
                    check_notify_paper: document.getElementById('notify_paper').checked?CHECKED:UNCHECKED,
                    check_notify_screen: document.getElementById('notify_screen').checked?CHECKED:UNCHECKED,
                    check_notify_email: document.getElementById('notify_email').checked?CHECKED:UNCHECKED,
                    check_notify_other: document.getElementById('notify_other').checked?CHECKED:UNCHECKED,
                    mail_name_a: document.getElementById('mail_name_a').value, mail_addr_a: document.getElementById('mail_addr_a').value,
                    mail_name_b: document.getElementById('mail_name_b').value, mail_addr_b: document.getElementById('mail_addr_b').value,
                    other_social_app: document.getElementById('other_social_text').value,

                    check_special_1: document.querySelector('input[name="specialOpt"][value="1"]').checked?CHECKED:UNCHECKED,
                    check_special_2: document.querySelector('input[name="specialOpt"][value="2"]').checked?CHECKED:UNCHECKED,
                    special_terms_text: specialText
                });

                saveAs(doc.getZip().generate({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}), "合約_"+document.getElementById('commName').value+".docx");
            } catch(e) { console.error(e); alert("生成失敗:"+e.message); }
        });
    }
</script>
</body>
</html>