<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合約自動化生成系統</title>
    
    <!-- 引入必要的函式庫 (已移除不穩定的 PizZipUtils) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        h3 { color: #0056b3; margin-top: 25px; }
        .page { display: none; }
        .page.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .btn-group { margin-top: 20px; text-align: right; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.success { background-color: #28a745; }
        button.success:hover { background-color: #218838; }
        .table-input { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 0.95em; }
        .table-input th, .table-input td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        .table-input th { background-color: #f8f9fa; color: #333; }
        .table-input input { text-align: center; }
        .read-only { background-color: #e9ecef; cursor: not-allowed; color: #495057; font-weight: bold; }
        .checkbox-group label { display: inline-block; margin-right: 15px; font-weight: normal; cursor: pointer; }
        .indent { margin-left: 20px; margin-top: 5px; border-left: 3px solid #eee; padding-left: 10px; }
        .hidden { display: none; }
        .required-mark { color: red; margin-left: 3px; }
        .info-box { background-color: #e2e3e5; padding: 15px; border-radius: 5px; margin-bottom: 20px; color: #383d41; border: 1px solid #d6d8db; }
    </style>
</head>
<body>

<div class="container">
    <h1>合約自動化生成程式</h1>
    
    <!-- 第一頁：合約類型 -->
    <div id="page1" class="page active">
        <h2>步驟 1/3：合約類型選擇</h2>
        <div class="form-group">
            <label>請選擇合約類型：</label>
            <div class="checkbox-group">
                <label><input type="radio" name="contractType" value="new" checked> 新簽約</label>
                <label><input type="radio" name="contractType" value="renew"> 續約</label>
            </div>
        </div>
        <div class="btn-group">
            <button onclick="nextPage(2)">下一步 &gt;</button>
        </div>
    </div>

    <!-- 第二頁：基本資料與費用 -->
    <div id="page2" class="page">
        <h2>步驟 2/3：基本資料與費用</h2>
        
        <!-- 2-1 合約期間 -->
        <h3>2-1. 合約期間</h3>
        <div class="row">
            <div class="col">
                <label>起始日期 (民國)</label>
                <div class="row">
                    <input type="number" id="startYear" placeholder="年" onchange="calcDuration()">
                    <input type="number" id="startMonth" placeholder="月" onchange="calcDuration()">
                    <input type="number" id="startDay" placeholder="日" onchange="calcDuration()">
                </div>
            </div>
            <div class="col">
                <label>結束日期 (民國)</label>
                <div class="row">
                    <input type="number" id="endYear" placeholder="年" onchange="calcDuration()">
                    <input type="number" id="endMonth" placeholder="月" onchange="calcDuration()">
                    <input type="number" id="endDay" placeholder="日" onchange="calcDuration()">
                </div>
            </div>
        </div>
        <div class="form-group" style="margin-top: 10px;">
            <label>期間計算結果 (自動產生)：</label>
            <input type="text" id="durationResult" class="read-only" readonly>
        </div>
        <div class="form-group">
            <label>封底日期 (民國)</label>
            <div class="row" style="max-width: 400px;">
                <input type="number" id="coverYear" placeholder="年">
                <input type="number" id="coverMonth" placeholder="月">
                <input type="number" id="coverDay" placeholder="日">
            </div>
        </div>

        <!-- 2-1 基本資料 -->
        <h3>基本資料</h3>
        <div class="row">
            <div class="col"><label>2-1-1 社區(大樓)名稱 <span class="required-mark">*</span></label><input type="text" id="commName" required></div>
            <div class="col"><label>2-1-2 社區(大樓)地址 <span class="required-mark">*</span></label><input type="text" id="commAddr" required></div>
        </div>
        <div class="row">
            <div class="col"><label>2-1-3 乙方 <span class="required-mark">*</span></label><input type="text" id="partyB" required></div>
            <div class="col"><label>2-1-4 代表人 <span class="required-mark">*</span></label><input type="text" id="repName" required></div>
        </div>
        <div class="row">
            <div class="col"><label>2-1-5 電話 <span class="required-mark">*</span></label><input type="text" id="phone" required></div>
            <div class="col"><label>2-1-6 統一編號</label><input type="text" id="taxId"></div>
        </div>

        <!-- 2-2 & 2-3 設備與費用 -->
        <h3>2-2 & 2-3. 設備與費用明細</h3>
        <table class="table-input">
            <thead>
                <tr>
                    <th width="20%">項目</th>
                    <th width="10%">數量(台)</th>
                    <th width="25%">安裝位置</th>
                    <th width="20%">單價(台/月)</th>
                    <th width="25%">小計(月)</th>
                </tr>
            </thead>
            <tbody>
                <!-- 序1 -->
                <tr>
                    <td>社區EIP聯網機 (序1)</td>
                    <td><input type="number" id="qty_eip_net_1" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_net_1" value="大廳/梯廳"></td>
                    <td><input type="number" id="price_eip_net_1" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_net_1" class="read-only" readonly></td>
                </tr>
                <!-- 序2 -->
                <tr>
                    <td>社區EIP聯網機 (序2)</td>
                    <td><input type="number" id="qty_eip_net_2" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_net_2" value="大廳/梯廳"></td>
                    <td><input type="number" id="price_eip_net_2" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_net_2" class="read-only" readonly></td>
                </tr>
                <!-- 序3 -->
                <tr>
                    <td>社區EIP公告機 (序3)</td>
                    <td><input type="number" id="qty_eip_anno" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_anno" value="電梯車廂內"></td>
                    <td><input type="number" id="price_eip_anno" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_anno" class="read-only" readonly></td>
                </tr>
                <!-- 合計 -->
                <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">合計 (月)</td>
                    <td><input type="text" id="total_monthly" class="read-only" readonly style="font-weight: bold; color: #d9534f;"></td>
                </tr>
            </tbody>
        </table>

        <!-- 2-4 帳戶資訊 (必填) -->
        <h3>2-4. 匯款帳戶 <span style="font-size:0.8em; color:red;">(此區皆為必填)</span></h3>
        <div class="row">
            <div class="col">
                <label>銀行 <span class="required-mark">*</span></label>
                <input type="text" id="bankName" placeholder="例如：台灣銀行" required>
            </div>
            <div class="col">
                <label>分行 <span class="required-mark">*</span></label>
                <input type="text" id="bankBranch" placeholder="例如：信義分行" required>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>戶名 <span class="required-mark">*</span></label>
                <input type="text" id="acctName" required>
            </div>
            <div class="col">
                <label>帳號 <span class="required-mark">*</span></label>
                <input type="text" id="acctNum" required>
            </div>
        </div>

        <div class="btn-group">
            <button class="secondary" onclick="prevPage(1)">&lt; 上一步</button>
            <button onclick="nextPage(3)">下一步 &gt;</button>
        </div>
    </div>

    <!-- 第三頁：條款與生成 -->
    <div id="page3" class="page">
        <h2>步驟 3/3：條款勾選與生成</h2>

        <!-- 3-1 -->
        <div class="form-group">
            <label>3-1. 【單選】第二條第二項：合作期間屆滿之處理方式</label>
            <div class="checkbox-group">
                <label><input type="radio" name="expiryOpt" value="1" checked> 自動延展壹年 (若未通知)</label><br>
                <label><input type="radio" name="expiryOpt" value="2"> 須重新簽訂書面合約 (否則終止)</label>
            </div>
        </div>

        <!-- 3-2 -->
        <div class="form-group">
            <label>3-2. 【複選】第三條：意思表示通知方式</label>
            <div><label><input type="checkbox" id="notify_line"> Line@ 帳號</label></div>
            <div><label><input type="checkbox" id="notify_paper"> 書面通知</label></div>
            <div><label><input type="checkbox" id="notify_screen"> 標的設備屏幕刊播</label></div>
            <div>
                <label><input type="checkbox" id="notify_email" onchange="toggleEmailInput()"> E-MAIL</label>
                <div id="emailInputArea" class="indent hidden">
                    <div class="row">
                        <div class="col"><small>甲方姓名</small><input type="text" id="mail_name_a"></div>
                        <div class="col"><small>甲方Email</small><input type="text" id="mail_addr_a"></div>
                    </div>
                    <div class="row">
                        <div class="col"><small>乙方姓名</small><input type="text" id="mail_name_b"></div>
                        <div class="col"><small>乙方Email</small><input type="text" id="mail_addr_b"></div>
                    </div>
                </div>
            </div>
            <div>
                <label><input type="checkbox" id="notify_other" onchange="toggleOtherInput()"> 其他社交通訊軟體</label>
                <div id="otherInputArea" class="indent hidden">
                    <input type="text" id="other_social_text" placeholder="請輸入軟體名稱">
                </div>
            </div>
        </div>

        <!-- 3-3 -->
        <div class="form-group">
            <label>3-3. 【單選】第五條：特別約定事項</label>
            <div class="checkbox-group">
                <label><input type="radio" name="specialOpt" value="1" checked onchange="toggleSpecialInput()"> 無</label><br>
                <label><input type="radio" name="specialOpt" value="2" onchange="toggleSpecialInput()"> 特別約定事項如下</label>
            </div>
            <div id="specialInputArea" class="indent hidden">
                <textarea id="special_terms_text" rows="4" placeholder="請輸入特別約定事項內容..."></textarea>
            </div>
        </div>

        <!-- 生成區域 -->
        <hr>
        <div class="info-box">
            <strong>系統提示：</strong> 程式將自動抓取 GitHub 上的 <code>template.docx</code> 範本進行套印。<br>
            請確保範本檔案已上傳且名稱正確。
        </div>

        <div class="btn-group">
            <button class="secondary" onclick="prevPage(2)">&lt; 上一步</button>
            <button class="success" onclick="generateContract()">立即生成合約 Word 檔</button>
        </div>
    </div>
</div>

<script>
    /* --- 核心功能函式 --- */

    // 1. 檔案讀取 (取代 PizZipUtils)
    function loadFile(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(e) {
            if (this.status === 200) {
                callback(null, this.response);
            } else {
                callback(new Error("Load failed: " + this.status));
            }
        };
        xhr.onerror = function() {
            callback(new Error("Network error"));
        };
        xhr.send();
    }

    // 2. 頁面切換
    function nextPage(page) {
        if(page === 3) {
            // 驗證必填欄位
            const reqFields = [
                'commName', 'commAddr', 'partyB', 'repName', 'phone',
                'bankName', 'bankBranch', 'acctName', 'acctNum'
            ];
            let valid = true;
            let firstError = null;

            reqFields.forEach(function(id) {
                const el = document.getElementById(id);
                if(!el.value.trim()) {
                    el.style.border = "2px solid red";
                    el.style.backgroundColor = "#fff0f0";
                    valid = false;
                    if(!firstError) firstError = el;
                } else {
                    el.style.border = "1px solid #ccc";
                    el.style.backgroundColor = "#fff";
                }
            });

            if(!valid) {
                alert("請填寫所有必填欄位！(標示 * 紅色框處)");
                if(firstError) firstError.scrollIntoView({behavior: "smooth", block: "center"});
                return;
            }
        }
        
        const pages = document.querySelectorAll('.page');
        for(let i=0; i<pages.length; i++) {
            pages[i].classList.remove('active');
        }
        document.getElementById('page' + page).classList.add('active');
        window.scrollTo(0, 0);
    }
    
    function prevPage(page) {
        const pages = document.querySelectorAll('.page');
        for(let i=0; i<pages.length; i++) {
            pages[i].classList.remove('active');
        }
        document.getElementById('page' + page).classList.add('active');
        window.scrollTo(0, 0);
    }

    // 3. UI 顯示切換
    function toggleEmailInput() {
        const chk = document.getElementById('notify_email');
        const area = document.getElementById('emailInputArea');
        if(chk.checked) area.classList.remove('hidden');
        else area.classList.add('hidden');
    }
    function toggleOtherInput() {
        const chk = document.getElementById('notify_other');
        const area = document.getElementById('otherInputArea');
        if(chk.checked) area.classList.remove('hidden');
        else area.classList.add('hidden');
    }
    function toggleSpecialInput() {
        const chk = document.querySelector('input[name="specialOpt"][value="2"]');
        const area = document.getElementById('specialInputArea');
        if(chk.checked) area.classList.remove('hidden');
        else area.classList.add('hidden');
    }

    // 4. 數字轉國字
    function numToChi(n) {
        const map = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
        if (n === 0) return map[0];
        if (n === null || isNaN(n)) return "零";
        let str = n.toString();
        let res = "";
        for(let i=0; i<str.length; i++) {
            res += map[parseInt(str[i])];
        }
        return res;
    }

    // 5. 計算日期
    function calcDuration() {
        const sY = parseInt(document.getElementById('startYear').value);
        const sM = parseInt(document.getElementById('startMonth').value);
        const sD = parseInt(document.getElementById('startDay').value);
        const eY = parseInt(document.getElementById('endYear').value);
        const eM = parseInt(document.getElementById('endMonth').value);
        const eD = parseInt(document.getElementById('endDay').value);

        if (!sY || !sM || !sD || !eY || !eM || !eD) return;

        const start = new Date(sY + 1911, sM - 1, sD);
        const end = new Date(eY + 1911, eM - 1, eD);
        
        let dEnd = new Date(end);
        dEnd.setDate(dEnd.getDate() + 1);
        
        let years = dEnd.getFullYear() - start.getFullYear();
        let months = dEnd.getMonth() - start.getMonth();
        let days = dEnd.getDate() - start.getDate();

        if (days < 0) {
            months--;
            let prevMonth = new Date(dEnd.getFullYear(), dEnd.getMonth(), 0);
            days += prevMonth.getDate();
        }
        if (months < 0) {
            years--;
            months += 12;
        }

        const chiMap = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
        let yStr = "";
        if(years < 10) yStr = chiMap[years];
        else yStr = numToChi(years);

        const mStr = months === 0 ? '零' : (months <= 9 ? chiMap[months] : (months === 10 ? '壹拾' : (months === 11 ? '壹拾壹' : '壹拾貳'))); 
        const dStr = days === 0 ? '零' : numToChi(days); 

        document.getElementById('durationResult').value = "共計" + yStr + "年" + mStr + "月" + dStr + "日";
    }

    // 6. 計算費用
    function calcFees() {
        let q1 = parseInt(document.getElementById('qty_eip_net_1').value) || 0;
        let p1 = parseInt(document.getElementById('price_eip_net_1').value) || 0;
        let sub1 = q1 * p1;
        document.getElementById('sub_eip_net_1').value = "$" + sub1;

        let q2 = parseInt(document.getElementById('qty_eip_net_2').value) || 0;
        let p2 = parseInt(document.getElementById('price_eip_net_2').value) || 0;
        let sub2 = q2 * p2;
        document.getElementById('sub_eip_net_2').value = "$" + sub2;

        let q3 = parseInt(document.getElementById('qty_eip_anno').value) || 0;
        let p3 = parseInt(document.getElementById('price_eip_anno').value) || 0;
        let sub3 = 0;
        if (q3 === 0) {
            document.getElementById('sub_eip_anno').value = "N/A";
            sub3 = 0;
        } else {
            sub3 = q3 * p3;
            document.getElementById('sub_eip_anno').value = "$" + sub3;
        }

        let total = sub1 + sub2 + sub3;
        document.getElementById('total_monthly').value = "$" + total;
    }

    // 7. 生成合約 (核心邏輯，改用 loadFile)
    function generateContract() {
        const templateURL = "./template.docx";
        
        // 改用自定義 loadFile 避免 PizZipUtils 錯誤
        loadFile(templateURL, function(error, content) {
            if (error) {
                alert("❌ 錯誤：無法讀取合約範本 (template.docx)。\n請確認檔案已上傳至 GitHub 且檔名大小寫完全一致。");
                console.error(error);
                return;
            }

            try {
                const CHECKED = "☑";
                const UNCHECKED = "☒";
                const isRenew = document.querySelector('input[name="contractType"]:checked').value === 'renew';
                
                const sY = document.getElementById('startYear').value || " ";
                const sM = (document.getElementById('startMonth').value || "").padStart(2, '0');
                const sD = (document.getElementById('startDay').value || "").padStart(2, '0');
                const eY = document.getElementById('endYear').value || " ";
                const eM = (document.getElementById('endMonth').value || "").padStart(2, '0');
                const eD = (document.getElementById('endDay').value || "").padStart(2, '0');
                
                const q1 = parseInt(document.getElementById('qty_eip_net_1').value) || 0;
                const q2 = parseInt(document.getElementById('qty_eip_net_2').value) || 0;
                const q3 = parseInt(document.getElementById('qty_eip_anno').value) || 0;
                
                const p1 = document.getElementById('price_eip_net_1').value;
                const p2 = document.getElementById('price_eip_net_2').value;
                
                const totalNet = q1 + q2; 
                const sub1 = q1 * (parseInt(p1)||0);
                const sub2 = q2 * (parseInt(p2)||0);
                const totalNetFee = sub1 + sub2;

                let loc1 = document.getElementById('loc_eip_net_1').value;
                let loc2 = document.getElementById('loc_eip_net_2').value;
                let locCombined = loc1;
                if(q2 > 0 && loc2.trim() !== "") {
                    locCombined = loc1 + " / " + loc2;
                }

                let priceCombined = "$" + p1;
                if(q2 > 0 && p1 !== p2) {
                    priceCombined = "$" + p1 + " / $" + p2;
                }
                
                const data = {
                    check_new_text: isRenew ? "1.新簽約☒、2.續約☑" : "1.新簽約☑、2.續約☒",
                    check_expiry_1: document.querySelector('input[name="expiryOpt"][value="1"]').checked ? CHECKED : UNCHECKED,
                    check_expiry_2: document.querySelector('input[name="expiryOpt"][value="2"]').checked ? CHECKED : UNCHECKED,
                    check_notify_line: document.getElementById('notify_line').checked ? CHECKED : UNCHECKED,
                    check_notify_paper: document.getElementById('notify_paper').checked ? CHECKED : UNCHECKED,
                    check_notify_screen: document.getElementById('notify_screen').checked ? CHECKED : UNCHECKED,
                    check_notify_email: document.getElementById('notify_email').checked ? CHECKED : UNCHECKED,
                    check_notify_other: document.getElementById('notify_other').checked ? CHECKED : UNCHECKED,
                    check_special_1: document.querySelector('input[name="specialOpt"][value="1"]').checked ? CHECKED : UNCHECKED,
                    check_special_2: document.querySelector('input[name="specialOpt"][value="2"]').checked ? CHECKED : UNCHECKED,

                    comm_name: document.getElementById('commName').value,
                    comm_addr: document.getElementById('commAddr').value,
                    party_b: document.getElementById('partyB').value,
                    rep_name: document.getElementById('repName').value,
                    phone: document.getElementById('phone').value,
                    tax_id: document.getElementById('taxId').value,
                    
                    bank_info: document.getElementById('bankName').value + "-" + document.getElementById('bankBranch').value,
                    acct_name: document.getElementById('acctName').value,
                    acct_num: document.getElementById('acctNum').value,

                    date_start: "中華民國" + sY + "年" + sM + "月" + sD + "日",
                    date_end: eY + "年" + eM + "月" + eD + "日",
                    duration_str: document.getElementById('durationResult').value,
                    date_cover: (document.getElementById('coverYear').value) ? "中華民國" + document.getElementById('coverYear').value + "年" + document.getElementById('coverMonth').value + "月" + document.getElementById('coverDay').value + "日" : "",

                    qty_eip_net_chi: totalNet === 0 ? "N/A" : numToChi(totalNet),
                    qty_eip_anno_chi: q3 === 0 ? "N/A" : numToChi(q3),
                    
                    loc_eip_net: locCombined,
                    loc_eip_anno: document.getElementById('loc_eip_anno').value,

                    qty_total_net: totalNet,
                    qty_eip_net: totalNet,
                    price_eip_net: priceCombined,
                    sub_eip_net: "$" + totalNetFee,

                    qty_eip_anno: q3 === 0 ? "N/A" : q3,
                    price_eip_anno: q3 === 0 ? "N/A" : ("$" + document.getElementById('price_eip_anno').value),
                    sub_eip_anno: document.getElementById('sub_eip_anno').value,
                    
                    total_monthly: document.getElementById('total_monthly').value,

                    email_contact_info: document.getElementById('notify_email').checked ? "甲方：" + document.getElementById('mail_name_a').value + "、" + document.getElementById('mail_addr_a').value + "；乙方：" + document.getElementById('mail_name_b').value + "、" + document.getElementById('mail_addr_b').value : "",
                    other_social_app: document.getElementById('other_social_text').value,
                    special_terms_text: document.getElementById('special_terms_text').value
                };

                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                doc.render(data);

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                saveAs(out, "合約_" + data.comm_name + ".docx");
            } catch (error) {
                console.error(error);
                alert("生成失敗：" + error.message);
            }
        });
    }
</script>

</body>
</html>