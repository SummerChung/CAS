<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合約自動化生成系統</title>
    <!-- 引入必要的函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip-utils.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .page { display: none; }
        .page.active { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .btn-group { margin-top: 20px; text-align: right; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        .table-input { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .table-input th, .table-input td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .table-input th { background-color: #f2f2f2; }
        .read-only { background-color: #e9ecef; cursor: not-allowed; }
        .checkbox-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
        .indent { margin-left: 20px; margin-top: 5px; border-left: 3px solid #eee; padding-left: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>合約自動化生成程式</h1>
    
    <!-- 第一頁 -->
    <div id="page1" class="page active">
        <h2>步驟 1/3：合約類型選擇</h2>
        <div class="form-group">
            <label>請選擇合約類型：</label>
            <div class="checkbox-group">
                <label><input type="radio" name="contractType" value="new" checked> 新簽約</label>
                <label><input type="radio" name="contractType" value="renew"> 續約</label>
            </div>
        </div>
        <div class="btn-group">
            <button onclick="nextPage(2)">下一步 &gt;</button>
        </div>
    </div>

    <!-- 第二頁 -->
    <div id="page2" class="page">
        <h2>步驟 2/3：基本資料與費用</h2>
        
        <!-- 2-1 合約期間 -->
        <h3>2-1. 合約期間</h3>
        <div class="row">
            <div class="col">
                <label>起始日期 (民國)</label>
                <div class="row">
                    <input type="number" id="startYear" placeholder="年" onchange="calcDuration()">
                    <input type="number" id="startMonth" placeholder="月" onchange="calcDuration()">
                    <input type="number" id="startDay" placeholder="日" onchange="calcDuration()">
                </div>
            </div>
            <div class="col">
                <label>結束日期 (民國)</label>
                <div class="row">
                    <input type="number" id="endYear" placeholder="年" onchange="calcDuration()">
                    <input type="number" id="endMonth" placeholder="月" onchange="calcDuration()">
                    <input type="number" id="endDay" placeholder="日" onchange="calcDuration()">
                </div>
            </div>
        </div>
        <div class="form-group" style="margin-top: 10px;">
            <label>期間計算結果 (自動產生)：</label>
            <input type="text" id="durationResult" class="read-only" readonly>
        </div>
        <div class="form-group">
            <label>封底日期 (民國)</label>
            <div class="row" style="max-width: 400px;">
                <input type="number" id="coverYear" placeholder="年">
                <input type="number" id="coverMonth" placeholder="月">
                <input type="number" id="coverDay" placeholder="日">
            </div>
        </div>

        <!-- 2-1 基本資料 -->
        <h3>基本資料</h3>
        <div class="row">
            <div class="col"><label>2-1-1 社區(大樓)名稱 <span style="color:red">*</span></label><input type="text" id="commName" required></div>
            <div class="col"><label>2-1-2 社區(大樓)地址 <span style="color:red">*</span></label><input type="text" id="commAddr" required></div>
        </div>
        <div class="row">
            <div class="col"><label>2-1-3 乙方 <span style="color:red">*</span></label><input type="text" id="partyB" required></div>
            <div class="col"><label>2-1-4 代表人 <span style="color:red">*</span></label><input type="text" id="repName" required></div>
        </div>
        <div class="row">
            <div class="col"><label>2-1-5 電話 <span style="color:red">*</span></label><input type="text" id="phone" required></div>
            <div class="col"><label>2-1-6 統一編號</label><input type="text" id="taxId"></div>
        </div>

        <!-- 2-2 & 2-3 設備與費用 -->
        <h3>2-2 & 2-3. 設備與費用明細</h3>
        <table class="table-input">
            <thead>
                <tr>
                    <th width="20%">項目</th>
                    <th width="15%">數量(台)</th>
                    <th width="25%">安裝位置</th>
                    <th width="20%">單價(台/月)</th>
                    <th width="20%">小計(月)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>社區EIP聯網機 (序1)</td>
                    <td><input type="number" id="qty_eip_net_1" value="0" min="0" onchange="calcFees()"></td>
                    <td rowspan="2"><input type="text" id="loc_eip_net" value="大廳/梯廳"></td>
                    <td rowspan="2"><input type="number" id="price_eip_net" value="0" onchange="calcFees()"></td>
                    <td rowspan="2"><input type="text" id="sub_eip_net" class="read-only" readonly></td>
                </tr>
                <tr>
                    <td>社區EIP聯網機 (序2)</td>
                    <td><input type="number" id="qty_eip_net_2" value="0" min="0" onchange="calcFees()"></td>
                </tr>
                <tr>
                    <td>社區EIP公告機 (序3)</td>
                    <td><input type="number" id="qty_eip_anno" value="0" min="0" onchange="calcFees()"></td>
                    <td><input type="text" id="loc_eip_anno" value="電梯車廂內"></td>
                    <td><input type="number" id="price_eip_anno" value="0" onchange="calcFees()"></td>
                    <td><input type="text" id="sub_eip_anno" class="read-only" readonly></td>
                </tr>
                <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">合計 (月)</td>
                    <td><input type="text" id="total_monthly" class="read-only" readonly style="font-weight: bold;"></td>
                </tr>
            </tbody>
        </table>

        <!-- 2-4 帳戶資訊 -->
        <h3>2-4. 匯款帳戶</h3>
        <div class="row">
            <div class="col"><label>銀行</label><input type="text" id="bankName" placeholder="例如：台灣銀行"></div>
            <div class="col"><label>分行</label><input type="text" id="bankBranch" placeholder="例如：信義分行"></div>
        </div>
        <div class="row">
            <div class="col"><label>戶名</label><input type="text" id="acctName"></div>
            <div class="col"><label>帳號</label><input type="text" id="acctNum"></div>
        </div>

        <div class="btn-group">
            <button class="secondary" onclick="prevPage(1)">&lt; 上一步</button>
            <button onclick="nextPage(3)">下一步 &gt;</button>
        </div>
    </div>

    <!-- 第三頁 -->
    <div id="page3" class="page">
        <h2>步驟 3/3：條款勾選</h2>

        <!-- 3-1 -->
        <div class="form-group">
            <label>3-1. 【單選】第二條第二項：合作期間屆滿之處理方式</label>
            <div class="checkbox-group">
                <label><input type="radio" name="expiryOpt" value="1" checked> 自動延展壹年 (若未通知)</label><br>
                <label><input type="radio" name="expiryOpt" value="2"> 須重新簽訂書面合約 (否則終止)</label>
            </div>
        </div>

        <!-- 3-2 -->
        <div class="form-group">
            <label>3-2. 【複選】第三條：意思表示通知方式</label>
            <div><label><input type="checkbox" id="notify_line"> Line@ 帳號</label></div>
            <div><label><input type="checkbox" id="notify_paper"> 書面通知</label></div>
            <div><label><input type="checkbox" id="notify_screen"> 標的設備屏幕刊播</label></div>
            <div>
                <label><input type="checkbox" id="notify_email" onchange="toggleEmailInput()"> E-MAIL</label>
                <div id="emailInputArea" class="indent hidden">
                    <div class="row">
                        <div class="col"><small>甲方姓名</small><input type="text" id="mail_name_a"></div>
                        <div class="col"><small>甲方Email</small><input type="text" id="mail_addr_a"></div>
                    </div>
                    <div class="row">
                        <div class="col"><small>乙方姓名</small><input type="text" id="mail_name_b"></div>
                        <div class="col"><small>乙方Email</small><input type="text" id="mail_addr_b"></div>
                    </div>
                </div>
            </div>
            <div>
                <label><input type="checkbox" id="notify_other" onchange="toggleOtherInput()"> 其他社交通訊軟體</label>
                <div id="otherInputArea" class="indent hidden">
                    <input type="text" id="other_social_text" placeholder="請輸入軟體名稱">
                </div>
            </div>
        </div>

        <!-- 3-3 -->
        <div class="form-group">
            <label>3-3. 【單選】第五條：特別約定事項</label>
            <div class="checkbox-group">
                <label><input type="radio" name="specialOpt" value="1" checked onchange="toggleSpecialInput()"> 無</label><br>
                <label><input type="radio" name="specialOpt" value="2" onchange="toggleSpecialInput()"> 特別約定事項如下</label>
            </div>
            <div id="specialInputArea" class="indent hidden">
                <textarea id="special_terms_text" rows="4" placeholder="請輸入特別約定事項內容..."></textarea>
            </div>
        </div>

        <!-- 檔案上傳與生成 -->
        <hr>
        <div class="form-group" style="background: #eef; padding: 15px; border-radius: 5px;">
            <label>最後步驟：請上傳合約範本 Word 檔 (.docx)</label>
            <input type="file" id="uploadTemplate" accept=".docx">
        </div>

        <div class="btn-group">
            <button class="secondary" onclick="prevPage(2)">&lt; 上一步</button>
            <button onclick="generateContract()" style="background-color: #28a745;">生成合約 Word 檔</button>
        </div>
    </div>
</div>

<script>
    // 頁面切換邏輯
    function nextPage(page) {
        if(page === 2 && !validatePage1()) return; // 簡易驗證
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page' + page).classList.add('active');
    }
    function prevPage(page) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page' + page).classList.add('active');
    }
    function validatePage1() { return true; } // 可擴充

    // 顯示隱藏邏輯
    function toggleEmailInput() {
        const chk = document.getElementById('notify_email');
        document.getElementById('emailInputArea').classList.toggle('hidden', !chk.checked);
    }
    function toggleOtherInput() {
        const chk = document.getElementById('notify_other');
        document.getElementById('otherInputArea').classList.toggle('hidden', !chk.checked);
    }
    function toggleSpecialInput() {
        const isSpecial = document.querySelector('input[name="specialOpt"][value="2"]').checked;
        document.getElementById('specialInputArea').classList.toggle('hidden', !isSpecial);
    }

    // 數字轉國字大寫
    function toChineseNum(num) {
        if(num === 0 || num === "0") return "零";
        const digit = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
        // 簡單處理個位數到十位數，合約年/月/日通常不超過兩位數
        // 針對數量轉換：
        let s = num.toString();
        let result = "";
        // 簡易實作，針對合約常用的整數
        if (num < 0) return "負" + toChineseNum(-num);
        if (num === 10) return "拾";
        if (num > 10 && num < 20) return "拾" + digit[num % 10];
        // 此處主要用於年月日計算，若要處理大金額建議引用更完整函式庫，
        // 但題目需求為"數量(台)"轉大寫，和"年月日"轉大寫。
        // 這裡實作簡易版供年月日與數量使用(數量0-99)
        if (s.length === 1) return digit[num];
        if (s.length > 1) {
            // 處理金額或較大數字暫用阿拉伯數字或需更複雜邏輯
            // 這裡針對題目需求的"壹年參月"這種格式
            return digit[num]; // 暫時 fallback，下方的 calcDuration 會客製化處理
        }
        return num;
    }

    function numToChi(n) {
        const map = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
        if (n === 0) return map[0];
        if (n === null || isNaN(n)) return "零";
        let str = n.toString();
        let res = "";
        for(let char of str) {
            res += map[parseInt(char)];
        }
        return res;
    }

    // 計算日期區間
    function calcDuration() {
        const sY = parseInt(document.getElementById('startYear').value);
        const sM = parseInt(document.getElementById('startMonth').value);
        const sD = parseInt(document.getElementById('startDay').value);
        const eY = parseInt(document.getElementById('endYear').value);
        const eM = parseInt(document.getElementById('endMonth').value);
        const eD = parseInt(document.getElementById('endDay').value);

        if (!sY || !sM || !sD || !eY || !eM || !eD) return;

        // 轉為西元計算差距
        const start = new Date(sY + 1911, sM - 1, sD);
        const end = new Date(eY + 1911, eM - 1, eD);

        // 計算年、月、日差 (包含頭尾，通常合約算法是 End - Start + 1 day，或依範例邏輯)
        // 範例1：1/1 ~ 12/31 = 1年0月0日 (這是滿一年的意思)
        // 邏輯：先算年月差，再看日期
        
        // 使用簡易邏輯模擬範例：
        // 將結束日期+1天來計算整數差 (例如 12/31 結束算做隔年 1/1 的前一刻)
        let dEnd = new Date(end);
        dEnd.setDate(dEnd.getDate() + 1);
        
        let years = dEnd.getFullYear() - start.getFullYear();
        let months = dEnd.getMonth() - start.getMonth();
        let days = dEnd.getDate() - start.getDate();

        if (days < 0) {
            months--;
            // 上個月有幾天
            let prevMonth = new Date(dEnd.getFullYear(), dEnd.getMonth(), 0);
            days += prevMonth.getDate();
        }
        if (months < 0) {
            years--;
            months += 12;
        }

        // 轉大寫國字
        const chiMap = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
        // 特殊處理：題目要求 "壹年零月零日"
        const yStr = chiMap[years]; // 假設不超過9年，超過需改邏輯
        const mStr = months === 0 ? '零' : (months <= 9 ? chiMap[months] : (months === 10 ? '壹拾' : (months === 11 ? '壹拾壹' : '壹拾貳'))); // 簡易處理
        const dStr = days === 0 ? '零' : numToChi(days); // 簡易處理

        // 修正題目範例：114/01/01-114/12/31 => 壹年零月零日
        // 若計算出來是 1年 0月 0日，顯示如題目
        let resultStr = `共計${yStr}年${mStr}月${dStr}日`;
        document.getElementById('durationResult').value = resultStr;
    }

    // 計算費用
    function calcFees() {
        // 數量
        let q1 = parseInt(document.getElementById('qty_eip_net_1').value) || 0;
        let q2 = parseInt(document.getElementById('qty_eip_net_2').value) || 0;
        let q3 = parseInt(document.getElementById('qty_eip_anno').value) || 0;
        
        // 單價
        let pNet = parseInt(document.getElementById('price_eip_net').value) || 0;
        let pAnno = parseInt(document.getElementById('price_eip_anno').value) || 0;

        // 計算聯網機 (序1+序2)
        let totalNetQty = q1 + q2;
        let subNet = totalNetQty * pNet;
        document.getElementById('sub_eip_net').value = "$" + subNet;

        // 計算公告機
        let subAnno = 0;
        let subAnnoStr = "N/A";
        if (q3 === 0) {
            document.getElementById('sub_eip_anno').value = "N/A";
            // 若數量0，費用視為0計算總和
            subAnno = 0;
        } else {
            subAnno = q3 * pAnno;
            document.getElementById('sub_eip_anno').value = "$" + subAnno;
        }

        // 總計
        let total = subNet + subAnno;
        document.getElementById('total_monthly').value = "$" + total;
    }

// 生成文件 (支援自動讀取網站上的 template.docx)
    function generateContract() {
        // 定義範本檔案名稱 (需與你上傳到 GitHub 的檔名一致)
        var templateURL = "./template.docx";

        // 使用 PizZipUtils 讀取遠端檔案
        PizZipUtils.getBinaryContent(templateURL, function(error, content) {
            if (error) {
                alert("錯誤：找不到合約範本 (template.docx)。\n請確認檔案已上傳至 GitHub 儲存庫。");
                console.error(error);
                return;
            }

            // 以下邏輯與原本相同，開始處理資料
            // 1. 符號定義
            const CHECKED = "☑";
            const UNCHECKED = "☒";
            
            // 2. 取值
            const isRenew = document.querySelector('input[name="contractType"]:checked').value === 'renew';
            
            const sY = document.getElementById('startYear').value;
            const sM = document.getElementById('startMonth').value.padStart(2, '0');
            const sD = document.getElementById('startDay').value.padStart(2, '0');
            const eY = document.getElementById('endYear').value;
            const eM = document.getElementById('endMonth').value.padStart(2, '0');
            const eD = document.getElementById('endDay').value.padStart(2, '0');
            
            const dateStart = `中華民國${sY}年${sM}月${sD}日`;
            const dateEnd = `${eY}年${eM}月${eD}日`;
            
            const cY = document.getElementById('coverYear').value;
            const cM = document.getElementById('coverMonth').value;
            const cD = document.getElementById('coverDay').value;
            const dateCover = (cY && cM && cD) ? `中華民國${cY}年${cM}月${cD}日` : "";

            // 設備數量
            const q1 = parseInt(document.getElementById('qty_eip_net_1').value) || 0;
            const q2 = parseInt(document.getElementById('qty_eip_net_2').value) || 0;
            const q3 = parseInt(document.getElementById('qty_eip_anno').value) || 0;
            const totalNet = q1 + q2;

            const qty_eip_net_chi = totalNet === 0 ? "N/A" : numToChi(totalNet);
            const qty_eip_anno_chi = q3 === 0 ? "N/A" : numToChi(q3);

            const pNet = document.getElementById('price_eip_net').value;
            const pAnno = document.getElementById('price_eip_anno').value;
            const subNet = document.getElementById('sub_eip_net').value;
            const subAnno = document.getElementById('sub_eip_anno').value;
            const totalMonthly = document.getElementById('total_monthly').value;
            
            const qtyAnnoDisplay = q3 === 0 ? "N/A" : q3;
            const priceAnnoDisplay = q3 === 0 ? "N/A" : ("$" + pAnno);

            let emailText = "";
            if (document.getElementById('notify_email').checked) {
                emailText = `甲方：${document.getElementById('mail_name_a').value}、${document.getElementById('mail_addr_a').value}；\n乙方：${document.getElementById('mail_name_b').value}、${document.getElementById('mail_addr_b').value}`;
            }

            const data = {
                check_new_text: isRenew ? "1.新簽約☒、2.續約☑" : "1.新簽約☑、2.續約☒",
                check_expiry_1: document.querySelector('input[name="expiryOpt"][value="1"]').checked ? CHECKED : UNCHECKED,
                check_expiry_2: document.querySelector('input[name="expiryOpt"][value="2"]').checked ? CHECKED : UNCHECKED,
                check_notify_line: document.getElementById('notify_line').checked ? CHECKED : UNCHECKED,
                check_notify_paper: document.getElementById('notify_paper').checked ? CHECKED : UNCHECKED,
                check_notify_screen: document.getElementById('notify_screen').checked ? CHECKED : UNCHECKED,
                check_notify_email: document.getElementById('notify_email').checked ? CHECKED : UNCHECKED,
                check_notify_other: document.getElementById('notify_other').checked ? CHECKED : UNCHECKED,
                check_special_1: document.querySelector('input[name="specialOpt"][value="1"]').checked ? CHECKED : UNCHECKED,
                check_special_2: document.querySelector('input[name="specialOpt"][value="2"]').checked ? CHECKED : UNCHECKED,
                comm_name: document.getElementById('commName').value,
                comm_addr: document.getElementById('commAddr').value,
                party_b: document.getElementById('partyB').value,
                rep_name: document.getElementById('repName').value,
                phone: document.getElementById('phone').value,
                tax_id: document.getElementById('taxId').value,
                bank_info: `${document.getElementById('bankName').value}-${document.getElementById('bankBranch').value}`,
                acct_name: document.getElementById('acctName').value,
                acct_num: document.getElementById('acctNum').value,
                date_start: dateStart,
                date_end: dateEnd,
                duration_str: document.getElementById('durationResult').value,
                date_cover: dateCover,
                qty_eip_net_chi: qty_eip_net_chi,
                qty_eip_anno_chi: qty_eip_anno_chi,
                loc_eip_net: document.getElementById('loc_eip_net').value,
                loc_eip_anno: document.getElementById('loc_eip_anno').value,
                qty_total_net: totalNet,
                qty_eip_net: totalNet,
                price_eip_net: "$" + pNet,
                sub_eip_net: subNet,
                qty_eip_anno: qtyAnnoDisplay,
                price_eip_anno: priceAnnoDisplay,
                sub_eip_anno: subAnno,
                total_monthly: totalMonthly,
                email_contact_info: emailText,
                other_social_app: document.getElementById('other_social_text').value,
                special_terms_text: document.getElementById('special_terms_text').value
            };

            try {
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });
                doc.render(data);
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                saveAs(out, `合約_${data.comm_name}.docx`);
            } catch (error) {
                console.error(error);
                alert("生成失敗：" + error.message);
            }
        });
    }
        reader.readAsBinaryString(fileInput.files[0]);
    }
</script>

</body>
</html>